<!DOCTYPE html>
<html lang="ta">

<head>
    <meta charset="UTF-8">
    <title>роирпЗро░роЯро┐ роЙро░рпИ роорпВро▓роорпН роЙро░рпИ рооро╛ро▒рпНро▒ро▓рпН</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='live.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>

<body>
    <nav>
        <a href="/" class="home-btn">
        <img src="{{ url_for('static', filename='images/home.jpg') }}" alt="роорпБроХрокрпНрокрпБ" class="home-icon">
    </a>

    </nav>

    <div class="container">
         <h1>роирпЗро░роЯро┐ роЙро░рпИ роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБ</h1>
         <p>рокродро┐ро╡рпБ роЪрпЖропрпНроп родрпБро╡роЩрпНроХро┐, рокрпЗроЪрпБроЩрпНроХро│рпН, роиро┐ро▒рпБродрпНродро┐роп рокро┐ро▒роХрпБ роЗро▒рпБродро┐ роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБ роХрпАро┤рпЗ роХро╛рогрпНрокро┐роХрпНроХрокрпНрокроЯрпБроорпН.</p>
         <hr>
        <div class="language-selectors">
            <div>
                <label for="source_lang">роЙроЩрпНроХро│рпН рокрпЗроЪрпБроорпН роорпКро┤ро┐ :</label>
                <select id="source_lang" name="source_lang" required>
                    <option value="IN">роЖроЩрпНроХро┐ро▓роорпН</option>
                    <option value="ta">родрооро┐ро┤рпН</option>
                    <option value="hi">ро╣ро┐роирпНродро┐</option>
                    <option value="kn">роХройрпНройроЯроорпН</option>
                </select>
            </div>
            <div>
                <label for="target_lang">роЙроЩрпНроХро│рпН рокрпЗроЪрпБроорпН роорпКро┤ро┐:</label>
                <select id="target_lang" name="target_lang" required>
                    <option value="ta">родрооро┐ро┤рпН</option>
                    <option value="en">роЖроЩрпНроХро┐ро▓роорпН</option>
                    <option value="hi">ро╣ро┐роирпНродро┐</option>
                    <option value="kn">роХройрпНройроЯроорпН</option>
                </select>
            </div>
        </div>

        <div id="recordingControls">
            <button id="startBtn">рокродро┐ро╡рпИ родрпБро╡роЩрпНроХрпБ ЁЯФ┤</button>
            <button id="stopBtn" disabled>рокродро┐ро╡рпИ роиро┐ро▒рпБродрпНродрпБ тП╣я╕П</button>
            <p id="status">'рокродро┐ро╡рпИ родрпБро╡роЩрпНроХрпБ' рокрпКродрпНродро╛ройрпИ роЕро┤рпБродрпНродро╡рпБроорпН</p>
        </div>

        <div id="results" style="display: none;">
            <h2>роЗро▒рпБродро┐ роорпКро┤ро┐рокрпЖропро░рпНрокрпНрокрпБ роЙро░рпИ</h2>
            <div id="translationBox" class="dialog-box"></div>
            <a id="downloadLink" href="#" style="display: none;" download>ро╕рпНроХро┐ро░ро┐рокрпНроЯрпИ рокродро┐ро╡ро┐ро▒роХрпНроХроорпН роЪрпЖропрпНропро╡рпБроорпН (.txt)</a>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const translationBox = document.getElementById('translationBox');
        let mediaRecorder;
        let socket;

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                socket = io();

                socket.on('connect', () => {
                    console.log('WebSocket connected!');
                    socket.emit('start_live_session', {
                        source_lang: document.getElementById('source_lang').value,
                        target_lang: document.getElementById('target_lang').value
                    });

                    // Start recording only after the server confirms the session
                    socket.on('session_started', () => {
                        mediaRecorder.start(2000); // Send audio chunks every 2 seconds
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                        statusEl.innerText = "Recording... Speak now.";
                        translationBox.innerText = "Recording in progress...";
                        document.getElementById('results').style.display = 'block';
                        document.getElementById('downloadLink').style.display = 'none';
                    });
                });

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        socket.emit('audio_chunk', event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                    statusEl.innerText = "Processing... Please wait for the final result.";
                    socket.emit('end_live_session');
                };

                socket.on('final_translation_update', (data) => {
                    translationBox.innerText = data.translated_text;
                    statusEl.innerText = "Session ended. Press 'Start Recording' for a new session.";
                });

                socket.on('download_ready', (data) => {
                    const downloadLink = document.getElementById('downloadLink');
                    if (data.download_link) {
                        downloadLink.href = data.download_link;
                        downloadLink.style.display = 'block';
                    }
                    socket.disconnect(); // Disconnect after getting the final link
                });

            } catch (error) {
                alert("Could not start recording. Please grant microphone permissions.");
                console.error("Microphone access error:", error);
            }
        });

        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
    </script>
</body>

</html>